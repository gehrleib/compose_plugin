Icon="cubes"
Author="dcflachs"
Title="Compose"
Type="xmenu"
Menu="Utilities"
---
<?php 
include "/usr/local/emhttp/plugins/dynamix.docker.manager/include/DockerClient.php";
require_once("/usr/local/emhttp/plugins/compose.manager/php/defines.php");
$cfg = parse_plugin_cfg($sName);
$ui_patch_button_type = (strcmp($cfg['PATCH_UI'],"true") == 0 && !isset($composemanDockerClientPatch)) ? "Button" : "Hidden";
$ui_unpatch_button_type = (strcmp($cfg['PATCH_UI'],"false") == 0 && isset($composemanDockerClientPatch)) ? "Button" : "Hidden";

$option_patch_ui = version_compare(parse_ini_file('/etc/unraid-version')['version'],'6.12.0-RC0', '>=');
$ui_patch_help_class = $option_patch_ui ? "hidden" : "inline_help";

$projects_exist = intval(shell_exec("ls -l ".$compose_root." | grep ^d | wc -l")) != 0;
?>
<style>
  <?php
      if ($option_patch_ui)
      {
        echo "dl:nth-last-of-type(2){display:none;}";
      }
  ?>
  /* Tab styles */
  .compose-tabs {
    display: flex;
    border-bottom: 1px solid #ccc;
    margin-bottom: 20px;
  }
  .compose-tab {
    padding: 10px 20px;
    cursor: pointer;
    border: 1px solid transparent;
    border-bottom: none;
    margin-bottom: -1px;
    background: transparent;
    color: inherit;
  }
  .compose-tab:hover {
    background: rgba(128, 128, 128, 0.1);
  }
  .compose-tab.active {
    border: 1px solid #ccc;
    border-bottom: 1px solid #fff;
    background: #fff;
    font-weight: bold;
  }
  /* Dark theme support */
  body.black .compose-tab.active {
    border-bottom-color: #1c1c1c;
    background: #1c1c1c;
  }
  body.azure .compose-tab.active {
    border-bottom-color: #f2f2f2;
    background: #f2f2f2;
  }
  body.gray .compose-tab.active {
    border-bottom-color: #e8e8e8;
    background: #e8e8e8;
  }
  .compose-tab-content {
    display: none;
  }
  .compose-tab-content.active {
    display: block;
  }
  /* Log viewer styles */
  #compose-log-container {
    font-family: monospace;
    font-size: 12px;
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 10px;
    border-radius: 4px;
    height: 500px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  #compose-log-container .log-timestamp {
    color: #6a9955;
  }
  #compose-log-container .log-source {
    color: #569cd6;
  }
  #compose-log-container .log-message {
    color: #d4d4d4;
  }
  .log-controls {
    margin-bottom: 10px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }
  .log-controls select, .log-controls input[type="text"] {
    padding: 5px;
  }
  .log-controls input[type="text"] {
    width: 200px;
  }
  #log-line-count {
    margin-left: auto;
    color: #888;
  }
</style>
<script>
var caURL = "/plugins/compose.manager/php/exec.php";
var logRefreshInterval = null;
var autoScroll = true;

function patchWebui() {
  $.post(caURL,{action:'patchUI'}, function(data) {
    window.location.reload();
  })
}

function unpatchWebui() {
  $.post(caURL,{action:'unPatchUI'}, function(data) {
    window.location.reload();
  })
}

function clearUpdateCache() {
  swal({
    title: 'Clear Update Cache',
    text: 'This will clear the update status cache and remove stale entries. You will need to check for updates again.',
    type: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Clear Cache'
  }, function() {
    $.post(caURL, {action: 'clearUpdateCache'}, function(data) {
      var result = JSON.parse(data);
      if (result.result === 'success') {
        swal('Success', 'Update cache has been cleared.', 'success');
      } else {
        swal('Error', result.message || 'Failed to clear cache', 'error');
      }
    });
  });
}

function checkProjectFolder() {
  var projects_folder_not_empty = <?php echo json_encode($projects_exist); ?>;
  var original_folder = "<?php echo $cfg['PROJECTS_FOLDER'] ?>";

  if(projects_folder_not_empty & ($(this).val() != original_folder))
  {
    $("#PROJECTS_FOLDER_WARNING").show();
  }
  else
  {
    $("#PROJECTS_FOLDER_WARNING").hide();
  }
}

function toggleAutoCheckInterval() {
  var autoCheckEnabled = $('#AUTO_CHECK_UPDATES').val() === 'true';
  if (autoCheckEnabled) {
    $('#auto_check_interval_row').slideDown();
  } else {
    $('#auto_check_interval_row').slideUp();
  }
}

$(function() {
  $('#PROJECTS_FOLDER').on("input", null, null, checkProjectFolder);
  
  // Tab switching
  $('.compose-tab').on('click', function() {
    var tabId = $(this).data('tab');
    
    // Update tab state
    $('.compose-tab').removeClass('active');
    $(this).addClass('active');
    
    // Show content
    $('.compose-tab-content').removeClass('active');
    $('#compose-tab-' + tabId).addClass('active');
    
    // Save tab preference
    localStorage.setItem('compose-settings-tab', tabId);
    
    // Start/stop log refresh based on tab
    if (tabId === 'log') {
      loadLogs();
      startLogRefresh();
    } else {
      stopLogRefresh();
    }
  });
  
  // Restore saved tab
  var savedTab = localStorage.getItem('compose-settings-tab') || 'settings';
  $('.compose-tab[data-tab="' + savedTab + '"]').click();
});

function loadLogs() {
  var lines = $('#log-lines').val() || 100;
  var filter = $('#log-filter').val() || '';
  
  $.post(caURL, {
    action: 'getLogs',
    lines: lines,
    filter: filter
  }, function(data) {
    try {
      var result = JSON.parse(data);
      if (result.result === 'success') {
        $('#compose-log-container').html(formatLogEntries(result.logs));
        $('#log-line-count').text(result.count + ' lines');
        if (autoScroll) {
          var container = document.getElementById('compose-log-container');
          container.scrollTop = container.scrollHeight;
        }
      } else {
        $('#compose-log-container').html('<span style="color: #f44;">Error loading logs: ' + (result.message || 'Unknown error') + '</span>');
      }
    } catch(e) {
      $('#compose-log-container').html('<span style="color: #f44;">Error parsing response</span>');
    }
  });
}

function formatLogEntries(logs) {
  if (!logs || logs.length === 0) {
    return '<span style="color: #888;">No log entries found. Enable Debug Logging in Settings to capture compose commands.</span>';
  }
  
  var html = '';
  logs.forEach(function(entry) {
    html += '<div class="log-entry">';
    html += '<span class="log-timestamp">' + escapeHtml(entry.timestamp) + '</span> ';
    html += '<span class="log-source">' + escapeHtml(entry.source) + '</span>: ';
    html += '<span class="log-message">' + escapeHtml(entry.message) + '</span>';
    html += '</div>';
  });
  return html;
}

function escapeHtml(text) {
  var div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function startLogRefresh() {
  stopLogRefresh();
  var interval = parseInt($('#log-refresh').val()) || 0;
  if (interval > 0) {
    logRefreshInterval = setInterval(loadLogs, interval * 1000);
  }
}

function stopLogRefresh() {
  if (logRefreshInterval) {
    clearInterval(logRefreshInterval);
    logRefreshInterval = null;
  }
}

function clearLogs() {
  swal({
    title: 'Clear Logs',
    text: 'This will clear compose-related entries from the syslog. Are you sure?',
    type: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Clear'
  }, function() {
    // Note: We can't actually clear syslog entries, so just refresh
    loadLogs();
  });
}

function downloadLogs() {
  var lines = $('#log-lines').val() || 100;
  var filter = $('#log-filter').val() || '';
  
  $.post(caURL, {
    action: 'getLogs',
    lines: lines,
    filter: filter
  }, function(data) {
    try {
      var result = JSON.parse(data);
      if (result.result === 'success' && result.logs) {
        var text = result.logs.map(function(entry) {
          return entry.timestamp + ' ' + entry.source + ': ' + entry.message;
        }).join('\n');
        
        var blob = new Blob([text], {type: 'text/plain'});
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'compose-manager-logs.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    } catch(e) {
      swal('Error', 'Failed to download logs', 'error');
    }
  });
}

function toggleAutoScroll() {
  autoScroll = $('#log-autoscroll').is(':checked');
}

</script>

<!-- Tab Navigation -->
<div class="compose-tabs">
  <div class="compose-tab active" data-tab="settings"><i class="fa fa-cog fa-fw"></i> _(Settings)_</div>
  <div class="compose-tab" data-tab="log"><i class="fa fa-file-text-o fa-fw"></i> _(Log)_</div>
</div>

<!-- Settings Tab -->
<div id="compose-tab-settings" class="compose-tab-content active">
<form markdown="1" name="compose_manager_settings" method="POST" action="/update.php" target="progressFrame">
<input type="hidden" name="#file" value="<?=$sName?>/<?=$sName?>.cfg">

_(Compose Project Directory)_:
: <input type="text" name="PROJECTS_FOLDER" id="PROJECTS_FOLDER" autocomplete="off" spellcheck="false" value="<?=$cfg['PROJECTS_FOLDER']?>" placeholder="_(e.g.)_ /mnt/user/appdata/compose_projects" data-pickcloseonfile="true" data-pickfilter="img" data-pickroot="/mnt" data-pickfolders="true" required pattern="^\/(mnt\/.+\/.+)||(\/boot\/config\/plugins\/compose\.manager\/projects)$">
  <a class='info nohand' id="PROJECTS_FOLDER_WARNING" onclick="HelpButton();return false;" style="display: none;">
    <i class='fa fa-warning orb yellow-orb'></i>
    <span style='left:18px'><strong>Projects exist that will not be moved to the new project folder.</strong></span>
  </a>

<blockquote class="inline_help" id="PROJECTS_FOLDER_HELP" style="display: none;">
  Choose the folder in which compose.manager will store your stacks.<br>
  <strong>WARNING: Changing this path will not automatically move your existing project folders.</strong>
</blockquote>

_(Compose Command Progress Display)_:
: <select name="OUTPUTSTYLE">
  <?=mk_option($cfg['OUTPUTSTYLE'], "basic", _("Basic"))?>
  <?=mk_option($cfg['OUTPUTSTYLE'], "ttyd", _("Terminal"))?>
  </select>

<blockquote class="inline_help" style="display: none;">
  Choose the style of output for plugin commands.<br>
  When set to <strong>basic</strong> the output will be simple text as elsewhere in the webui.<br>
  When set to <strong>ttyd</strong> the output will be a terminal window with colored text.
</blockquote>

_(Debug Logging)_:
: <select name="DEBUG_TO_LOG">
  <?=mk_option($cfg['DEBUG_TO_LOG'], "false", _("Disabled"))?>
  <?=mk_option($cfg['DEBUG_TO_LOG'], "true", _("Enabled"))?>
  </select>

<blockquote class="inline_help" style="display: none;">
  Enable debug logging.
</blockquote>

_(Recreate During Autostart)_:
: <select name="AUTOSTART_FORCE_RECREATE">
  <?=mk_option($cfg['AUTOSTART_FORCE_RECREATE'], "false", _("Disabled"))?>
  <?=mk_option($cfg['AUTOSTART_FORCE_RECREATE'], "true", _("Enabled"))?>
  </select>

<blockquote class="inline_help" style="display: none;">
  Use the --force-recreate option when autostarting stacks.<br> 
  This will recreate each stack container on startup.<br>
  This can work around an issue where containers refuse to autostart because the 
  network they are attached to no longer exists.
</blockquote>

_(Show Compose in Header Menu)_:
: <select name="SHOW_COMPOSE_IN_HEADER_MENU">
  <?=mk_option($cfg['SHOW_COMPOSE_IN_HEADER_MENU'], "false", _("No"))?>
  <?=mk_option($cfg['SHOW_COMPOSE_IN_HEADER_MENU'], "true", _("Yes"))?>
  </select>

<blockquote class="inline_help">
  This will move the Compose Manager page to a separate tab in the Unraid Header menu.
</blockquote>

_(Auto Check for Updates)_:
: <select name="AUTO_CHECK_UPDATES" id="AUTO_CHECK_UPDATES" onchange="toggleAutoCheckInterval()">
  <?=mk_option($cfg['AUTO_CHECK_UPDATES'], "false", _("Disabled"))?>
  <?=mk_option($cfg['AUTO_CHECK_UPDATES'], "true", _("Enabled"))?>
  </select>

<blockquote class="inline_help" style="display: none;">
  Automatically check for container image updates when the Compose page loads.<br>
  Updates will only be checked if the interval has elapsed since the last check.
</blockquote>

<div id="auto_check_interval_row" style="display: <?=$cfg['AUTO_CHECK_UPDATES'] == 'true' ? 'block' : 'none'?>;">
_(Auto Check Interval (days))_:
: <input type="number" name="AUTO_CHECK_UPDATES_DAYS" id="AUTO_CHECK_UPDATES_DAYS" min="0.04" max="30" step="0.01" value="<?=$cfg['AUTO_CHECK_UPDATES_DAYS'] ?? '1'?>" style="width:80px;">
  <span class="fa fa-question-circle fa-fw" onclick="HelpButton();return false;"></span>

<blockquote class="inline_help" style="display: none;">
  How often to automatically check for updates (in days).<br>
  Examples: 0.04 (hourly), 1 (daily), 7 (weekly), 30 (monthly).<br>
  Minimum: 0.04 days (about 1 hour). Maximum: 30 days.
</blockquote>
</div>

_(Clear Update Cache)_:
: <input type="button" value="_(Clear Cache)_" onclick="clearUpdateCache()">

<blockquote class="inline_help" style="display: none;">
  Clears the cached update status for all compose containers.<br>
  Use this if update checks are showing incorrect results or if you want to force a fresh check.<br>
  After clearing, use "Check for Updates" on the Compose page to recheck all containers.
</blockquote>

_(Patch unRAID WebUI)_:
: <select name="PATCH_UI">
  <?=mk_option($cfg['PATCH_UI'], "false", _("No"))?>
  <?=mk_option($cfg['PATCH_UI'], "true", _("Yes"))?>
  </select>
  <span class="fa fa-question-circle fa-fw" onclick="HelpButton();return false;"></span>
  <input type=<?=$ui_patch_button_type?> value="_(Patch)_" onclick="patchWebui()">
  <input type=<?=$ui_unpatch_button_type?> value="_(Unpatch)_" onclick="unpatchWebui()">

<blockquote class=<?=$ui_patch_help_class?> style="display: none;">
  Apply patches to the webui to improve the integration of containers started by compose.manager.<br>
  When set to <strong>yes</strong> the patches can be activated with the <strong>Patch</strong> button or by reboot.<br>
  When set to <strong>no</strong> the patches can be removed with the <strong>Unpatch</strong> button or by reboot.<br>
</blockquote>

<input type="submit" name="#default" value="_(Default)_">
: <input type="submit" name="#apply" value="_(Apply)_" disabled><input type="button" value="_(Done)_" onclick="done()">
</form>
</div>

<!-- Log Tab -->
<div id="compose-tab-log" class="compose-tab-content">
<div class="log-controls">
  <label>_(Lines)_: 
    <select id="log-lines" onchange="loadLogs()">
      <option value="50">50</option>
      <option value="100" selected>100</option>
      <option value="250">250</option>
      <option value="500">500</option>
      <option value="1000">1000</option>
    </select>
  </label>
  <label>_(Refresh)_: 
    <select id="log-refresh" onchange="startLogRefresh()">
      <option value="0">_(Manual)_</option>
      <option value="5">5s</option>
      <option value="10">10s</option>
      <option value="30">30s</option>
      <option value="60">60s</option>
    </select>
  </label>
  <label>_(Filter)_: 
    <input type="text" id="log-filter" placeholder="_(Search logs...)_" onkeyup="if(event.keyCode==13)loadLogs()">
  </label>
  <input type="button" value="_(Refresh)_" onclick="loadLogs()">
  <input type="button" value="_(Download)_" onclick="downloadLogs()">
  <label style="display: flex; align-items: center; gap: 5px;">
    <input type="checkbox" id="log-autoscroll" checked onchange="toggleAutoScroll()"> _(Auto-scroll)_
  </label>
  <span id="log-line-count"></span>
</div>
<div id="compose-log-container">
  <span style="color: #888;">_(Loading logs...)_</span>
</div>
<blockquote class="inline_help">
  <p>This log shows compose-related entries from the system log.</p>
  <p>Enable <strong>Debug Logging</strong> in Settings to capture detailed compose command information.</p>
  <p>Log entries are generated by the <code>logger</code> command when compose operations are performed.</p>
</blockquote>
</div>
